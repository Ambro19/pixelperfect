services:
  - type: web
    name: pixelperfect-api
    env: python
    plan: starter
    region: oregon

    buildCommand: |
      set -e

      echo "üì¶ Installing system dependencies..."
      apt-get update -qq
      apt-get install -y --no-install-recommends ffmpeg
      rm -rf /var/lib/apt/lists/*

      echo "üêç Installing Python dependencies..."
      python -m pip install --upgrade pip
      pip install --no-cache-dir -r requirements.txt

      echo "üé≠ Installing Playwright Chromium (with OS deps)..."
      python -m playwright install --with-deps chromium

      echo "‚úÖ Build complete!"

    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT --workers 2
    healthCheckPath: /health

    envVars:
      - key: ENVIRONMENT
        value: production
      - key: DEBUG
        value: "false"
      - key: HOST
        value: 0.0.0.0

      # IMPORTANT: do NOT set PORT manually; Render injects it automatically.

      - key: FRONTEND_URL
        value: https://pixelperfectapi.net
      - key: BACKEND_URL
        value: https://api.pixelperfectapi.net
      - key: CORS_ORIGINS
        value: https://pixelperfectapi.net,https://www.pixelperfectapi.net

      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        sync: false

      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false

      - key: STRIPE_PRO_LOOKUP_KEY
        value: pixelperfect_pro_monthly
      - key: STRIPE_BUSINESS_LOOKUP_KEY
        value: pixelperfect_business_monthly

      - key: R2_ENDPOINT_URL
        value: https://[account-id].r2.cloudflarestorage.com
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET_NAME
        value: pixelperfect-screenshots
      - key: R2_PUBLIC_URL
        value: https://screenshots.pixelperfectapi.net

      - key: FILE_RETENTION_DAYS
        value: "7"

      - key: CONTACT_RECIPIENT
        value: onetechly@gmail.com
      - key: CONTACT_FROM
        value: no-reply@onetechly.com

      - key: RATE_LIMIT_ENABLED
        value: "true"
      - key: RATE_LIMIT_FREE_TIER
        value: "120"

      - key: BATCH_WEBHOOK_URL
        value: ""
      - key: BATCH_WEBHOOK_SECRET
        value: ""


# ============================================================================
# DEPLOYMENT CHECKLIST
# ============================================================================
# 
# Before deploying, ensure you have:
# 
# 1. Set SECRET_KEY in Render Dashboard:
#    python -c "import secrets; print(secrets.token_urlsafe(64))"
# 
# 2. Set DATABASE_URL (PostgreSQL connection string)
# 
# 3. Set all STRIPE_ secrets from your Stripe Dashboard
# 
# 4. Set R2_ secrets from Cloudflare R2 dashboard
# 
# 5. Update R2_ENDPOINT_URL with your actual account ID
# 
# 6. Verify FRONTEND_URL and BACKEND_URL are correct
# 
# 7. Create Stripe products with lookup keys:
#    - pixelperfect_pro_monthly ($49/month)
#    - pixelperfect_business_monthly ($199/month)
# 
# 8. Set up Stripe webhook endpoint:
#    https://api.pixelperfectapi.net/webhook/stripe
# 
# ============================================================================